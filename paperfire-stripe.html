<link rel="import" href="../polymer/polymer-element.html">
<script src="https://checkout.stripe.com/checkout.js"></script>

<dom-module id="paperfire-stripe">
  <template>
    <style>
       :host {
        display: block;
      }
    </style>

    <pre hidden$="[[!debug]]">amount to charge: [[amount]]</pre>

  </template>

  <script>
    /**
     * `paperfire-stripe`
     * A stripe payment element
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class PaperfireStripe extends Polymer.Element {
      static get is() {
        return 'paperfire-stripe';
      }
      static get properties() {
        return {
          // Allow Remember me in form
          allowRememberMe: {
            type: Boolean,
            value: true
          },
          // Amount to charge
          amount: {
            type: Number,
            value: 2000,
            notify: true
          },
          // Collect billing address
          billingAddress: {
            type: Boolean,
            value: false
          },
          // Allow pay with bitcoin
          bitcoin: {
            type: Boolean,
            value: false
          },
          // currency
          currency: {
            type: String,
            value: 'USD'
          },
          // Debug the element with console logs
          debug: Boolean,
          // Description of Product
          description: {
            type: String,
            value: '2 widgets'
          },
          // Prefill Email
          email: String,
          // Stripe Error
          error: {
            type: Boolean,
            value: false
          },
          // Stripe Error messge
          errorMessage: String,
          // URL to location in firebase you want the response from stripe to be pushed
          firebaseUrl: {
            type: String,
            readOnly: true
          },
          // Image Url
          image: {
            type: String,
            value: 'https://stripe.com/img/documentation/checkout/marketplace.png'
          },
          // locale of currency
          locale: {
            type: String,
            value: 'auto'
          },
          // Name of Product
          name: {
            type: String,
            value: 'Demo Site'
          },
          // Stripe publishable key
          pubKey: {
            type: String,
            value: 'pk_test_6pRNASCoBOKtIshFeQd4XMUh'
          },

          // Collect Shipping Address
          shippingAddress: {
            type: Boolean,
            value: false
          },

          // Collect zip code for verification
          zipCode: {
            type: Boolean,
            value: true
          },
          // Stripe Checkout object
          _checkout: {
            type: Object,
            notify: true
          },
          // Firebase ref
          _ref: Object
        };
      }

      ready() {
        super.ready();
        if (this.firebaseUrl && firebase) {
          this._ref = firebase.database().ref(this.firebaseUrl);
        }
        if (!this.pubKey) {
          console.error('Error: No stripe publishable key found');
        } else {
           this._initCheckout();
            this.addEventListener('popstate', () => this._checkout.close());
        }

        window.addEventListener('paperfire-stripe-checkout', () => this.handleCheckout());
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        if (this._ref) {
          this._ref.off();
        }
        window.removeEventListener('paperfire-stripe-checkout');
      }

      handleCheckout() {
        if (this.debug) {
          console.log('PAPERFIRE_STRIPE:checkout opened');
        }
        // this._initCheckout();
        this._checkout.open({
          name: this.name,
          description: this.description,
          amount: this.amount
        });
      }

      _initCheckout() {
        const vm = this;
        if (this.debug) {
          console.info('<paperfire-stripe>', {
            allowRememberMe: this.allowRememberMe,
            amount: this.amount,
            billingAddress: this.billingAddress,
            bitcoin: this.bitcoin,
            currency: this.currency,
            description: this.description,
            email: this.email,
            firebaseUrl: this.firebaseUrl,
            image: this.image,
            locale: this.locale,
            name: this.name,
            pubKey: this.pubKey,
            shippingAddress: this.shippingAddress,
            zipCode: this.zipCode
          });
        }
        this.set('_checkout', StripeCheckout.configure({
            allowRememberMe: this.allowRememberMe,
            currency: this.currency,
            billingAddress: this.billingAddress,
            bitcoin: this.bitcoin,
            email: this.email ? this.email : null,
            key: this.pubKey,
            image: this.image,
            currency: this.currency,
            shippingAddress: this.shippingAddress,
            locale: this.locale,
            zipCode: this.zipCode,
            token: (token) => {
              if (vm.debug) {
                console.log('PAPERFIRE_STRIPE:token', token);
              }
              vm.dispatchEvent(new CustomEvent('paperfire-stripe-token', {
                detail: token,
                bubbles: true,
                composed: true
              }));
              if (this._ref) {
                this._ref.push(token).then(() => {
                  if (vm.debug) {
                    console.log('PAPERFIRE_STRIPE:push success');
                  }
                  vm.dispatchEvent(new CustomEvent('paperfire-stripe-pushed', {
                    detail: token,
                    bubbles: true,
                    composed: true
                  }));
                }).catch(err => {
                  console.error('PAPERFIRE_STRIPE:firebase push error', err);
                });
              }
            }
          }));
      }
    }

    window.customElements.define(PaperfireStripe.is, PaperfireStripe);
  </script>
</dom-module>